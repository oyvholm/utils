#!/bin/sh

#==============================================================================
# Gen-version
# File ID: STDuuidDTS
#
# Generate version.h
#
# Author: Ã˜yvind A. Holm <sunny@sunbase.org>
# License: GNU General Public License version 2 or later.
#==============================================================================

progname=Gen-version

exec_version=0.0.0
exec_date=STDyearDTS-00-00

tag_prefix="v$exec_version"
has_git=$(git --version | grep -q "git version" && echo 1 || echo 0)

newdef() {
	echo "#define $1  1" >>version.h
}

if test -d ../.git -a $has_git -eq 1; then
	if git tag | grep -q ^$tag_prefix; then
		numsince=$(
		    git log --format=%h \
		        $tag_prefix.. 2>/dev/null |
		    wc -l |
		    tr -d '\t '
		).
	else
		numsince=''
	fi
	gitsha=$(git rev-parse --short=12 HEAD)
	test -n "$(git diff-index --name-only HEAD)" &&
		gitsha="$gitsha-dirty"
	exec_fullversion="$exec_version+${numsince}git-$gitsha"
	exec_date=$(git log -1 --format=%ci | cut -c -10)
else
	exec_fullversion=$exec_version
fi

cat <<END >version.h
/* Generated by $progname */
#define EXEC_VERSION  "$exec_fullversion"
#define EXEC_DATE  "$exec_date"
END

test -n "$GCOV" && newdef GCOV
test -n "$NDEBUG" && newdef NDEBUG

exit 0

# vim: set ts=8 sw=8 sts=8 noet fo+=w tw=79 fenc=UTF-8 :
