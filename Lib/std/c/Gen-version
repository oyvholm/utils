#!/bin/sh

#==============================================================================
# Gen-version
# File ID: STDuuidDTS
#
# Generate version.h
#
# Author: Ã˜yvind A. Holm <sunny@sunbase.org>
# License: GNU General Public License version 2 or later.
#==============================================================================

progname=Gen-version

STDexecDTS_version=0.0.0
STDexecDTS_date=STDyearDTS-00-00

tag_prefix="v$STDexecDTS_version"
has_git=$(git --version | grep -q "git version" && echo 1 || echo 0)

chkdef() {
	test -n "$1" && echo "#define $1  1" >>version.h
}

if test -d ../.git -a $has_git -eq 1; then
	if git tag | grep -q ^$tag_prefix; then
		numsince=$(
		    git log --format=%h \
		        $tag_prefix.. 2>/dev/null |
		    wc -l |
		    tr -d '\t '
		).
	else
		numsince=''
	fi
	gitsha=$(git rev-parse --short=12 HEAD)
	test -n "$(git diff-index --name-only HEAD)" &&
		gitsha="$gitsha-dirty"
	STDexecDTS_fullversion="$STDexecDTS_version+${numsince}git-$gitsha"
	STDexecDTS_date=$(git log -1 --format=%ci | cut -c -10)
else
	STDexecDTS_fullversion=$STDexecDTS_version
fi

cat <<END >version.h
/* Generated by $progname */
#define STDUexecUDTS_VERSION  "$STDexecDTS_fullversion"
#define STDUexecUDTS_DATE  "$STDexecDTS_date"
END

chkdef NDEBUG

exit 0

# vim: set ts=8 sw=8 sts=8 noet fo+=w tw=79 fenc=UTF-8 :
