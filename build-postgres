#!/bin/bash

#=======================================================================
# build-postgres
# File ID: 86126f82-2e60-11e5-bf33-fefdb24f8e10
#
# Compile and install the Postgres version stored in $srcdir .
#
# Author: Ã˜yvind A. Holm <sunny@sunbase.org>
# License: GNU General Public License version 2 or later.
#=======================================================================

progname=build-postgres
VERSION=0.1.0

if test "$1" = "--version"; then
    echo $progname $VERSION
    exit 0
fi

if test "$1" = "-h" -o "$1" = "--help"; then
    cat <<END

Usage: $progname [options]

Options:

  -h, --help
    Show this help.
  --version
    Print version information.

END
    exit 0
fi

msg() {
    echo >&2
    echo $progname: $* >&2
    return
}

srcdir="$HOME/src/other/postgres"
cd "$srcdir" || exit 1
git wait-until-clean -i

user=sunny
pgdesc="$(git desc --long --tags)"
pgdir="postgres-$pgdesc"
prefix="/usr/local"
prgdir="$prefix/prg"
destdir="$prefix/varprg/$pgdir"
dbroot="/var/lib/postgresql"

test -e "$destdir" && {
    echo $progname: $destdir already exists >&2
    exit 1
}

old_version="$($prgdir/postgres/bin/postgres --version 2>/dev/null)"

msg mkdir $destdir &&
sudo mkdir -p "$destdir" &&

msg chown $user.$user $destdir &&
sudo chown $user.$user "$destdir" &&

msg Patch src/tools/version_stamp.pl &&
patch -p1 <~/bin/Patch/postgres/add-git-version.diff &&

msg Execute src/tools/version_stamp.pl git &&
src/tools/version_stamp.pl git &&

msg Regenerate ./configure &&
autoconf &&

msg Run ./configure &&
./configure --prefix="$destdir" --enable-debug --with-libxml --with-openssl --with-perl --with-uuid=ossp &&

msg make all &&
make all &&

msg make check &&
make check &&

msg make install &&
make install &&

msg make in contrib/uuid-ossp/ &&
cd contrib/uuid-ossp &&
make &&

msg make install in contrib/uuid-ossp/ &&
make install &&
cd - &&

msg make in src/bin/pgbench/ &&
cd src/bin/pgbench &&
make &&

msg make install in src/bin/pgbench/ &&
make install &&
cd - &&

msg make in doc/ &&
cd doc &&
make &&

msg make install in doc/ &&
make install &&
cd - &&

msg Update the $prgdir/postgres symlink &&
cd "$prgdir" &&
(test -L postgres && sudo rm postgres || true) &&
sudo ln -sv "../varprg/$pgdir" postgres &&

msg Create manpage symlinks &&
for f in 1 3 7; do
    cd "$prefix/share/man/man$f" &&
    ln -sv ../../../prg/postgres/share/man/man$f/* . 2>/dev/null || true
done &&

msg Create \'current\' symlink to $pgdesc &&
until sudo -u postgres echo postgres pwd OK | grep -q "postgres pwd OK"; do
    :
done &&
sudo -u postgres ln -fnsv "$pgdesc" "$dbroot/current" &&

echo &&
echo $progname: Old version: $old_version >&2 &&
echo $progname: New version: $($prgdir/postgres/bin/postgres --version) >&2 &&
echo &&
echo $progname finished successfully >&2 &&
exit 0 || {
    msg Something went wrong, aborted
    sudo rmdir "$destdir"
    exit 1
}
