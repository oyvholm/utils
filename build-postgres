#!/bin/bash

#=======================================================================
# build-postgres
# File ID: 86126f82-2e60-11e5-bf33-fefdb24f8e10
#
# Compile and install the Postgres version stored in $srcdir .
#
# License: GNU General Public License version 2 or later.
#=======================================================================

progname=build-postgres

srcdir="$HOME/src/other/postgres"
cd "$srcdir" || exit 1
user=sunny
pgdir="postgres-$(git desc --long --tags)"
prgdir="/usr/local/prg"
destdir="/usr/local/varprg/$pgdir"
test -e "$destdir" && {
    echo $progname: $destdir already exists >&2
    exit 1
}
sudo rmdir "$destdir" 2>/dev/null

sudo mkdir -p "$destdir" &&
sudo chown $user.$user "$destdir" &&
git wait-until-clean -i &&
./configure --prefix="$destdir" --enable-debug --with-libxml --with-openssl --with-perl --with-uuid=ossp &&
make &&
make check &&
make install &&
cd "$prgdir" &&
(test -L postgres && sudo rm postgres || true) &&
sudo ln -sv "../varprg/$pgdir" postgres &&
/usr/local/prg/postgres/bin/postgres --version &&
echo $progname finished successfully >&2 &&
exit 0 || {
    echo $progname: Something went wrong, aborted >&2
    sudo rmdir "$destdir"
    exit 1
}
