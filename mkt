#!/bin/bash

#=======================================================================
# mkt
# File ID: dc74ffde-08f1-11de-a419-000475e441b9
#
# Creates a .tar.gz file of current directory
#
# Author: Ã˜yvind A. Holm <sunny@sunbase.org>
# License: GNU General Public License version 2 or later.
#=======================================================================

progname=mkt
VERSION=0.1.0

ARGS="$(getopt -o "\
g\
h\
n\
q\
r\
v\
" -l "\
gpg,\
help,\
nocomp,\
quiet,\
remove,\
verbose,\
version,\
" -n "$progname" -- "$@")"
test "$?" = "0" || exit 1
eval set -- "$ARGS"

opt_gpg=0
opt_help=0
opt_nocomp=0
opt_quiet=0
opt_remove=0
opt_verbose=0
while :; do
    case "$1" in
        (-g|--gpg) opt_gpg=1; shift ;;
        (-h|--help) opt_help=1; shift ;;
        (-n|--nocomp) opt_nocomp=1; shift ;;
        (-q|--quiet) opt_quiet=$(($opt_quiet + 1)); shift ;;
        (-r|--remove) opt_remove=1; shift ;;
        (-v|--verbose) opt_verbose=$(($opt_verbose + 1)); shift ;;
        (--version) echo $progname $VERSION; exit 0 ;;
        (--) shift; break ;;
        (*) echo $progname: Internal error >&2; exit 1 ;;
    esac
done
opt_verbose=$(($opt_verbose - $opt_quiet))

if test "$opt_help" = "1"; then
    test $opt_verbose -gt 0 && { echo; echo $progname $VERSION; }
    cat <<END

Creates a .tar.gz file of current directory tree and places it in parent 
directory. If nothing is specified, current dir is used.

Usage: $progname [options] name_without_the_tar_gz_extension

Options:

  -g, --gpg
    Use gpg instead of gzip.
  -h, --help
    Show this help.
  -n, --nocomp
    No compression, leave as .tar .
  -q, --quiet
    Be more quiet. Can be repeated to increase silence.
  -r, --remove
    Remove directory after packing.
  -v, --verbose
    Increase level of verbosity. Can be repeated.
  --version
    Print version information.

END
    exit 0
fi

# FIXME: Finn ut av -r kombinert med -n

if [ "$opt_gpg" = "1" ]; then
	_packcmd="gpg -e"
	_packext=".gpg"
else
	_packcmd="gzip -vN"
	_packext=".gz"
fi

if [ "$opt_nocomp" = "1" ]; then
	unset _packext
fi

if [ $# -eq 0 ]; then
	_prefix="$(basename "$(pwd)")"
else
	_prefix="$(basename "$1")"
fi

if [ -e "../$_prefix.tar" -o -e "../$_prefix.tar$_packext" ]; then
	echo $progname: ../$_prefix.tar or ../$_prefix.tar$_packext \
        already exists >&2
	exit 1
fi

if [ -e "../$_prefix" -a ! "../$_prefix" -ef . ]; then
	echo $progname: ../$_prefix and current dir are not the same >&2
	exit 1
fi

if [ -e "../$_prefix" -a ! -d "../$_prefix" ]; then
	echo $progname: ../$_prefix: Not a directory >&2
	exit 1
fi

if [ ! -e "../$_prefix" ]; then
	cp -a . "../$_prefix" || {
        echo "$progname: Error running \"cp -a . ../$_prefix\"" >&2
        exit 1
    }
fi

if [ ! -d "../$_prefix" ]; then
	echo $progname: Unable to create directory ../$_prefix >&2
	exit 1
fi

cd .. || { echo "$progname: Cannot \"cd ..\"" >&2; exit 1; }
uuid=$(
    suuid -m -t mkt --raw -w eo \
        -c "<c_mkt> <filename>$_prefix.tar$_packext</filename> <host>$(
            hostname
        )</host> <directory>$(/bin/pwd)</directory> </c_mkt>"
) || {
    echo $progname: suuid error >&2
    exit 1
}
find "$_prefix" -print0 |
    LC_COLLATE=C sort -z |
    tar cf "$_prefix.tar" --null -T - \
        --no-recursion --label=$uuid "$_prefix" || {
            echo "$progname: Error running tar in parent dir" >&2
            exit 1
        }

if [ "$opt_nocomp" = "1" ]; then
	exit 0
fi

$_packcmd "$_prefix.tar" || {
    echo "$progname: Error running \"$_packcmd $_prefix.tar\" \
        in parent dir" >&2
    exit 1
}

if [ "$_packext" = ".gpg" ]; then
	gitwipe "$_prefix.tar"
	sync
	rm -f "$_prefix.tar"
fi

if [ "$opt_remove" = "1" ]; then
	rm -rf "$_prefix" || {
        echo "$progname: $_prefix: Can't remove directory" >&2
        exit 1
    }
fi

# This program is free software; you can redistribute it and/or modify 
# it under the terms of the GNU General Public License as published by 
# the Free Software Foundation; either version 2 of the License, or (at 
# your option) any later version.
#
# This program is distributed in the hope that it will be useful, but 
# WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License 
# along with this program; if not, write to the Free Software 
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 
# USA

#### End of file mkt ####
